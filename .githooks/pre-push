#!/bin/sh
set -eu

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || true)
[ -n "$current_branch" ] || exit 0

remote=${1:-origin}
remote_ref="refs/remotes/$remote/$current_branch"

# Always fetch the matching branch before pushing so we know the latest remote state.
git fetch "$remote" "$current_branch"

if git show-ref --verify --quiet "$remote_ref"; then
    if ! git merge-base --is-ancestor "$remote_ref" "refs/heads/$current_branch"; then
        git rebase "$remote_ref"
    fi
fi
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || true)
[ -n "$current_branch" ] || exit 0

remote=${1:-origin}
remote_ref="refs/remotes/$remote/$current_branch"

# Always fetch the matching branch before pushing so we know the latest remote state.
git fetch "$remote" "$current_branch"

if git show-ref --verify --quiet "$remote_ref"; then
    if ! git merge-base --is-ancestor "$remote_ref" "refs/heads/$current_branch"; then
        git rebase "$remote_ref"
    fi
fi
